---
import Layout from '../../layouts/Layout.astro';
import AuthorCard from '../../components/AuthorCard.astro';
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async () => {
  const blogPosts = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });

  return blogPosts.map(post => ({
    params: { slug: post.id },
    props: { post },
  }));
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content, headings } = await post.render();
const author = await getEntry(post.data.author);

const formattedDate = new Date(post.data.pubDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Get related posts (same category or tags)
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

const relatedPosts = allPosts
  .filter(p => p.id !== post.id)
  .filter(p =>
    p.data.category === post.data.category ||
    p.data.tags.some(tag => post.data.tags.includes(tag))
  )
  .slice(0, 3);
---

<Layout title={`${post.data.title} - Embedded Linux Blog`} description={post.data.description}>
  <article class="max-w-4xl mx-auto">
    <header class="mb-8">
      <div class="mb-4">
        <a
          href={`/categories/${post.data.category.toLowerCase().replace(/\s+/g, '-')}`}
          class="font-semibold uppercase text-sm hover:underline hover:opacity-80 transition-opacity"
          style="color: var(--color-primary);"
        >
          {post.data.category}
        </a>
      </div>

      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4 leading-tight" style="color: var(--color-text);">
        {post.data.title}
      </h1>

      <p class="text-lg sm:text-xl mb-6 leading-relaxed" style="color: var(--color-text-light);">
        {post.data.description}
      </p>

      <div class="flex flex-wrap gap-2 sm:gap-4 items-center text-sm sm:text-base pb-6 border-b" style="color: var(--color-text-light); border-color: var(--color-border);">
        <time datetime={post.data.pubDate.toISOString()}>
          {formattedDate}
        </time>
        <span class="hidden sm:inline">•</span>
        <span>by {author.data.name}</span>
        {post.data.updatedDate && (
          <>
            <span class="hidden sm:inline">•</span>
            <span class="text-xs sm:text-base">Updated {new Date(post.data.updatedDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
          </>
        )}
      </div>
    </header>

    <div class="flex flex-wrap gap-2 mb-8">
      {post.data.tags.map(tag => (
        <a
          href={`/tags/${tag}`}
          class="px-3 py-1 rounded-full text-sm no-underline transition-colors hover:opacity-80"
          style="background-color: var(--color-bg-alt); color: var(--color-text); border: 1px solid var(--color-border);"
        >
          #{tag}
        </a>
      ))}
    </div>

    <div class="prose prose-lg max-w-none mb-12">
      <Content />
    </div>

    <AuthorCard author={author} />

    {relatedPosts.length > 0 && (
      <section class="mt-12 pt-8 border-t-2" style="border-color: var(--color-border);">
        <h2 class="text-2xl font-bold mb-6" style="color: var(--color-text);">Related Posts</h2>
        <div class="grid gap-4">
          {relatedPosts.map(related => (
            <article class="rounded-lg p-4 sm:p-6 hover:shadow-md transition-shadow" style="border: 1px solid var(--color-border);">
              <a href={`/blog/${related.id}`} class="no-underline group">
                <h3 class="text-lg sm:text-xl font-semibold mb-2 hover:opacity-80 transition-opacity" style="color: var(--color-primary);">
                  {related.data.title}
                </h3>
              </a>
              <p class="text-sm sm:text-base" style="color: var(--color-text-light);">
                {related.data.description}
              </p>
            </article>
          ))}
        </div>
      </section>
    )}
  </article>
</Layout>
