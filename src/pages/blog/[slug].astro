---
import Layout from '../../layouts/Layout.astro';
import AuthorCard from '../../components/AuthorCard.astro';
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async () => {
  const blogPosts = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });

  return blogPosts.map(post => ({
    params: { slug: post.id },
    props: { post },
  }));
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content, headings } = await post.render();
const author = await getEntry(post.data.author);

const formattedDate = new Date(post.data.pubDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Get related posts (same category or tags)
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

const relatedPosts = allPosts
  .filter(p => p.id !== post.id)
  .filter(p =>
    p.data.category === post.data.category ||
    p.data.tags.some(tag => post.data.tags.includes(tag))
  )
  .slice(0, 3);
---

<Layout title={`${post.data.title} - Embedded Linux Blog`} description={post.data.description}>
  <article>
    <header style="margin-bottom: 2rem;">
      <div style="margin-bottom: 1rem;">
        <a
          href={`/categories/${post.data.category.toLowerCase().replace(/\s+/g, '-')}`}
          style="color: var(--color-primary); font-weight: 600; text-transform: uppercase; font-size: 0.875rem;"
        >
          {post.data.category}
        </a>
      </div>

      <h1 style="font-size: 2.5rem; margin-bottom: 1rem; line-height: 1.2;">
        {post.data.title}
      </h1>

      <p style="font-size: 1.25rem; color: var(--color-text-light); margin-bottom: 1.5rem;">
        {post.data.description}
      </p>

      <div style="display: flex; gap: 1rem; align-items: center; color: var(--color-text-light); font-size: 0.95rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border);">
        <time datetime={post.data.pubDate.toISOString()}>
          {formattedDate}
        </time>
        <span>•</span>
        <span>by {author.data.name}</span>
        {post.data.updatedDate && (
          <>
            <span>•</span>
            <span>Updated {new Date(post.data.updatedDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
          </>
        )}
      </div>
    </header>

    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 2rem;">
      {post.data.tags.map(tag => (
        <a
          href={`/tags/${tag}`}
          style="background-color: var(--color-bg-alt); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; text-decoration: none; color: var(--color-text); border: 1px solid var(--color-border);"
        >
          #{tag}
        </a>
      ))}
    </div>

    <div class="prose" style="max-width: none; margin-bottom: 3rem;">
      <Content />
    </div>

    <AuthorCard author={author} />

    {relatedPosts.length > 0 && (
      <section style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid var(--color-border);">
        <h2 style="margin-bottom: 1.5rem;">Related Posts</h2>
        <div style="display: grid; gap: 1rem;">
          {relatedPosts.map(related => (
            <article style="border: 1px solid var(--color-border); border-radius: 0.5rem; padding: 1rem;">
              <a href={`/blog/${related.id}`} style="text-decoration: none; color: inherit;">
                <h3 style="color: var(--color-primary); margin-bottom: 0.5rem;">
                  {related.data.title}
                </h3>
              </a>
              <p style="color: var(--color-text-light); font-size: 0.9rem;">
                {related.data.description}
              </p>
            </article>
          ))}
        </div>
      </section>
    )}
  </article>

  <style>
    .prose {
      font-size: 1.125rem;
      line-height: 1.75;
    }

    .prose h2 {
      margin-top: 2rem;
      margin-bottom: 1rem;
      font-size: 1.875rem;
    }

    .prose h3 {
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      font-size: 1.5rem;
    }

    .prose h4 {
      margin-top: 1.25rem;
      margin-bottom: 0.5rem;
      font-size: 1.25rem;
    }

    .prose p {
      margin-bottom: 1.25rem;
    }

    .prose ul, .prose ol {
      margin-bottom: 1.25rem;
      padding-left: 1.5rem;
    }

    .prose li {
      margin-bottom: 0.5rem;
    }

    .prose blockquote {
      border-left: 4px solid var(--color-primary);
      padding-left: 1rem;
      margin: 1.5rem 0;
      font-style: italic;
      color: var(--color-text-light);
    }

    .prose table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
    }

    .prose th,
    .prose td {
      border: 1px solid var(--color-border);
      padding: 0.75rem;
      text-align: left;
    }

    .prose th {
      background-color: var(--color-bg-alt);
      font-weight: 600;
    }

    .prose img {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      margin: 1.5rem 0;
    }
  </style>
</Layout>
