---
import Layout from '../../layouts/Layout.astro';
import AuthorCard from '../../components/AuthorCard.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import { getLangFromId, getSlugWithoutLang } from '../../content/config';
import { useTranslations, formatDate, getPostTranslations } from '../../i18n/utils';
import { languages, getLocalizedPath } from '../../i18n/config';
import { siteConfig } from '../../config/site';

const lang = 'pl';
const t = useTranslations(lang);

export const getStaticPaths = (async () => {
  const blogPosts = await getCollection('blog', ({ id, data }) => {
    return data.draft !== true && getLangFromId(id) === 'pl';
  });

  return blogPosts.map(post => ({
    params: { slug: getSlugWithoutLang(post.slug) },
    props: { post },
  }));
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content, headings } = await post.render();
const author = post.data.author ? await getEntry(post.data.author) : null;

const formattedDate = formatDate(post.data.pubDate, lang);

// Get all posts for translations and related posts
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// Get translations of this post
const translations = getPostTranslations(post, allPosts);

// Build translation URLs for the language switcher
import type { Lang } from '../../i18n/config';
const translationUrls: Record<Lang, string> = {
  pl: `/blog/${getSlugWithoutLang(post.slug)}`,
  en: translations.find(t => t.lang === 'en')
    ? `/en/blog/${translations.find(t => t.lang === 'en')!.slug}`
    : `/en/blog/${getSlugWithoutLang(post.slug)}`,
};

// Get related posts (same category or tags, same language)
const sameLangPosts = allPosts.filter(p => getLangFromId(p.id) === lang);

// Sort posts by date for next/previous navigation
const sortedPosts = sameLangPosts.sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const currentIndex = sortedPosts.findIndex(p => p.slug === post.slug);
const prevPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

const relatedPosts = sameLangPosts
  .filter(p => p.slug !== post.slug)
  .filter(p =>
    p.data.category === post.data.category ||
    p.data.tags.some(tag => post.data.tags.includes(tag))
  )
  .slice(0, 3);

// Breadcrumb items
const breadcrumbItems = [
  { label: t('nav.blog'), href: '/blog' },
  { label: post.data.category, href: `/categories/${post.data.category.toLowerCase().replace(/\s+/g, '-')}` },
  { label: post.data.title },
];
---

<Layout title={`${post.data.title} - ${t('site.title')}`} description={post.data.description} lang={lang} translationUrls={translationUrls} canonicalUrl={post.data.canonicalUrl}>
  <!-- Reading Progress Bar -->
  <div id="reading-progress" class="fixed top-0 left-0 h-1 z-50 transition-all duration-150" style="width: 0%; background: linear-gradient(90deg, var(--color-primary) 0%, #9333ea 100%);"></div>

  <!-- Breadcrumbs -->
  <Breadcrumbs items={breadcrumbItems} lang={lang} />

  <!-- Sidebar TOC Layout -->
  <div class="max-w-7xl mx-auto flex gap-8">
    <article class="flex-1">
    <header class="mb-8">
      <div class="mb-4">
        <a
          href={`/categories/${post.data.category.toLowerCase().replace(/\s+/g, '-')}`}
          class="font-semibold uppercase text-sm hover:underline hover:opacity-80 transition-opacity"
          style="color: var(--color-primary);"
        >
          {post.data.category}
        </a>
      </div>

      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4 leading-tight" style="color: var(--color-text);">
        {post.data.title}
      </h1>

      <p class="text-lg sm:text-xl mb-6 leading-relaxed" style="color: var(--color-text-light);">
        {post.data.description}
      </p>

      <div class="flex flex-wrap gap-2 sm:gap-4 items-center text-sm sm:text-base pb-6 border-b" style="color: var(--color-text-light); border-color: var(--color-border);">
        <time datetime={post.data.pubDate.toISOString()}>
          {formattedDate}
        </time>
        <span class="hidden sm:inline">•</span>
        {author ? (
          <span>{t('blog.by')} <a href={`/authors/${post.data.author.id.split('/')[1]}`} class="no-underline hover:underline transition-opacity hover:opacity-80" style="color: var(--color-primary);">{author.data.name}</a></span>
        ) : post.data.originalAuthor ? (
          <span>{t('blog.by')} {post.data.originalAuthor}</span>
        ) : null}
        {post.data.updatedDate && (
          <>
            <span class="hidden sm:inline">•</span>
            <span class="text-xs sm:text-base">{t('post.updated')} {formatDate(post.data.updatedDate, lang)}</span>
          </>
        )}
      </div>

      {/* Language switcher for translations */}
      {siteConfig.enablePostTranslationLinks && translations.length > 0 && (
        <div class="flex items-center gap-2 mt-4 text-sm" style="color: var(--color-text-light);">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
          </svg>
          <span>Also available in:</span>
          {translations.map((trans, i) => (
            <>
              <a
                href={getLocalizedPath(`/blog/${trans.slug}`, trans.lang)}
                class="font-medium hover:underline"
                style="color: var(--color-primary);"
              >
                {languages[trans.lang]}
              </a>
              {i < translations.length - 1 && <span>,</span>}
            </>
          ))}
        </div>
      )}

      {/* External post indicator */}
      {siteConfig.enableExternalPosts && post.data.isExternal && post.data.canonicalUrl && (
        <div class="flex items-center gap-2 mt-4 p-3 rounded-lg text-sm" style="background-color: var(--color-bg-alt); border: 1px solid var(--color-border);">
          <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--color-primary);">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
          </svg>
          <span style="color: var(--color-text-light);">
            {t('post.originallyPublished')}
            <a
              href={post.data.canonicalUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="font-medium hover:underline ml-1"
              style="color: var(--color-primary);"
            >
              {post.data.externalSource || t('post.externalSource')}
            </a>
          </span>
        </div>
      )}
    </header>

    <!-- Interactive tag pills and share buttons -->
    <div class="flex flex-wrap gap-3 mb-8 items-center">
      <div class="flex flex-wrap gap-2">
        {post.data.tags.map(tag => (
          <a
            href={`/tags/${tag}`}
            class="px-4 py-2 rounded-full text-sm no-underline transition-all hover:scale-105 hover:shadow-md"
            style="background-color: var(--color-bg-alt); color: var(--color-text); border: 1px solid var(--color-border);"
          >
            #{tag}
          </a>
        ))}
      </div>
      <div class="flex gap-2 ml-auto">
        <button
          id="share-btn"
          class="p-2 rounded-lg transition-all hover:scale-110 hover:shadow-md"
          style="background-color: var(--color-bg-alt); border: 1px solid var(--color-border);"
          title={t('post.sharePost')}
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--color-text);">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="prose prose-lg max-w-none mb-12">
      <Content />
    </div>

    {author && <AuthorCard author={author} />}

    {relatedPosts.length > 0 && (
      <section class="mt-12 pt-8 border-t-2" style="border-color: var(--color-border);">
        <h2 class="text-2xl font-bold mb-6" style="color: var(--color-text);">{t('post.relatedPosts')}</h2>
        <div class="grid gap-4">
          {relatedPosts.map(related => (
            <article class="rounded-lg p-4 sm:p-6 hover:shadow-md transition-shadow" style="border: 1px solid var(--color-border);">
              <a href={`/blog/${getSlugWithoutLang(related.slug)}`} class="no-underline group">
                <h3 class="text-lg sm:text-xl font-semibold mb-2 hover:opacity-80 transition-opacity" style="color: var(--color-primary);">
                  {related.data.title}
                </h3>
              </a>
              <p class="text-sm sm:text-base" style="color: var(--color-text-light);">
                {related.data.description}
              </p>
            </article>
          ))}
        </div>
      </section>
    )}

    {/* Next/Previous Post Navigation */}
    {(prevPost || nextPost) && (
      <nav class="mt-12 pt-8 border-t-2" style="border-color: var(--color-border);">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          {prevPost ? (
            <a
              href={`/blog/${getSlugWithoutLang(prevPost.slug)}`}
              class="group p-4 rounded-lg no-underline transition-all hover:shadow-md"
              style="background-color: var(--color-bg-alt); border: 1px solid var(--color-border);"
            >
              <div class="flex items-center gap-2 text-sm mb-2" style="color: var(--color-text-light);">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                {lang === 'pl' ? 'Poprzedni wpis' : 'Previous post'}
              </div>
              <div class="font-medium group-hover:opacity-80 transition-opacity line-clamp-2" style="color: var(--color-text);">
                {prevPost.data.title}
              </div>
            </a>
          ) : (
            <div></div>
          )}
          {nextPost ? (
            <a
              href={`/blog/${getSlugWithoutLang(nextPost.slug)}`}
              class="group p-4 rounded-lg no-underline transition-all hover:shadow-md text-right"
              style="background-color: var(--color-bg-alt); border: 1px solid var(--color-border);"
            >
              <div class="flex items-center justify-end gap-2 text-sm mb-2" style="color: var(--color-text-light);">
                {lang === 'pl' ? 'Następny wpis' : 'Next post'}
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
              <div class="font-medium group-hover:opacity-80 transition-opacity line-clamp-2" style="color: var(--color-text);">
                {nextPost.data.title}
              </div>
            </a>
          ) : (
            <div></div>
          )}
        </div>
      </nav>
    )}
  </article>

  <!-- Sticky Table of Contents Sidebar -->
  {headings.length > 0 && (
    <aside class="hidden lg:block w-64 flex-shrink-0">
      <div class="sticky top-24 p-4 rounded-lg" style="background-color: var(--color-bg-alt); border: 1px solid var(--color-border);">
        <h3 class="font-bold mb-4 text-sm uppercase" style="color: var(--color-text);">{t('post.tableOfContents')}</h3>
        <nav class="space-y-2">
          {headings.map(heading => (
            <a
              href={`#${heading.slug}`}
              class="block text-sm no-underline hover:underline transition-opacity hover:opacity-80"
              style={`color: var(--color-text-light); padding-left: ${(heading.depth - 1) * 0.75}rem;`}
            >
              {heading.text}
            </a>
          ))}
        </nav>
      </div>
    </aside>
  )}
  </div>

  <script>
    // Reading progress indicator
    function updateReadingProgress() {
      const article = document.querySelector('article');
      const progressBar = document.getElementById('reading-progress');

      if (!article || !progressBar) return;

      const articleTop = article.offsetTop;
      const articleHeight = article.offsetHeight;
      const windowHeight = window.innerHeight;
      const scrollTop = window.scrollY;

      const progress = Math.min(
        100,
        Math.max(0, ((scrollTop - articleTop + windowHeight) / articleHeight) * 100)
      );

      progressBar.style.width = `${progress}%`;
    }

    window.addEventListener('scroll', updateReadingProgress);
    window.addEventListener('resize', updateReadingProgress);
    updateReadingProgress();

    // Share functionality
    document.getElementById('share-btn')?.addEventListener('click', async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: document.title,
            url: window.location.href
          });
        } catch (err) {
          console.log('Share cancelled');
        }
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard!');
      }
    });

    // Add copy buttons to code blocks
    function addCopyButtonsToCodeBlocks() {
      const codeBlocks = document.querySelectorAll('.prose pre');

      codeBlocks.forEach((pre) => {
        // Skip if button already exists
        if (pre.querySelector('.code-copy-btn')) return;

        const button = document.createElement('button');
        button.className = 'code-copy-btn';
        button.textContent = 'Copy';
        button.setAttribute('aria-label', 'Copy code to clipboard');

        button.addEventListener('click', async () => {
          const code = pre.querySelector('code');
          if (!code) return;

          // Get text content without line numbers
          const lines = code.querySelectorAll('.line');
          let textToCopy = '';

          if (lines.length > 0) {
            // Extract text from each line (skipping line number pseudo-element)
            textToCopy = Array.from(lines)
              .map(line => line.textContent)
              .join('\n');
          } else {
            // Fallback to entire code text
            textToCopy = code.textContent || '';
          }

          try {
            await navigator.clipboard.writeText(textToCopy);
            button.textContent = 'Copied!';
            button.classList.add('copied');

            setTimeout(() => {
              button.textContent = 'Copy';
              button.classList.remove('copied');
            }, 2000);
          } catch (err) {
            console.error('Failed to copy code:', err);
            button.textContent = 'Error';
            setTimeout(() => {
              button.textContent = 'Copy';
            }, 2000);
          }
        });

        pre.appendChild(button);
      });
    }

    // Initialize copy buttons
    addCopyButtonsToCodeBlocks();
  </script>
</Layout>
