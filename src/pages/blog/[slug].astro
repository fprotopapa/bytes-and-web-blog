---
import Layout from '../../layouts/Layout.astro';
import AuthorCard from '../../components/AuthorCard.astro';
import { getCollection, getEntry } from 'astro:content';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async () => {
  const blogPosts = await getCollection('blog', ({ data }) => {
    return data.draft !== true;
  });

  return blogPosts.map(post => ({
    params: { slug: post.id },
    props: { post },
  }));
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content, headings } = await post.render();
const author = await getEntry(post.data.author);

const formattedDate = new Date(post.data.pubDate).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Get related posts (same category or tags)
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

const relatedPosts = allPosts
  .filter(p => p.id !== post.id)
  .filter(p =>
    p.data.category === post.data.category ||
    p.data.tags.some(tag => post.data.tags.includes(tag))
  )
  .slice(0, 3);
---

<Layout title={`${post.data.title} - Embedded Linux Blog`} description={post.data.description}>
  <!-- Reading Progress Bar -->
  <div id="reading-progress" class="fixed top-0 left-0 h-1 z-50 transition-all duration-150" style="width: 0%; background: linear-gradient(90deg, var(--color-primary) 0%, #9333ea 100%);"></div>

  <!-- Sidebar TOC Layout -->
  <div class="max-w-7xl mx-auto flex gap-8">
    <article class="flex-1 max-w-4xl">
    <header class="mb-8">
      <div class="mb-4">
        <a
          href={`/categories/${post.data.category.toLowerCase().replace(/\s+/g, '-')}`}
          class="font-semibold uppercase text-sm hover:underline hover:opacity-80 transition-opacity"
          style="color: var(--color-primary);"
        >
          {post.data.category}
        </a>
      </div>

      <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4 leading-tight" style="color: var(--color-text);">
        {post.data.title}
      </h1>

      <p class="text-lg sm:text-xl mb-6 leading-relaxed" style="color: var(--color-text-light);">
        {post.data.description}
      </p>

      <div class="flex flex-wrap gap-2 sm:gap-4 items-center text-sm sm:text-base pb-6 border-b" style="color: var(--color-text-light); border-color: var(--color-border);">
        <time datetime={post.data.pubDate.toISOString()}>
          {formattedDate}
        </time>
        <span class="hidden sm:inline">•</span>
        <span>by <a href={`/authors/${post.data.author.id}`} class="no-underline hover:underline transition-opacity hover:opacity-80" style="color: var(--color-primary);">{author.data.name}</a></span>
        {post.data.updatedDate && (
          <>
            <span class="hidden sm:inline">•</span>
            <span class="text-xs sm:text-base">Updated {new Date(post.data.updatedDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
          </>
        )}
      </div>
    </header>

    <!-- Interactive tag pills and share buttons -->
    <div class="flex flex-wrap gap-3 mb-8 items-center">
      <div class="flex flex-wrap gap-2">
        {post.data.tags.map(tag => (
          <a
            href={`/tags/${tag}`}
            class="px-4 py-2 rounded-full text-sm no-underline transition-all hover:scale-105 hover:shadow-md"
            style="background-color: var(--color-bg-alt); color: var(--color-text); border: 1px solid var(--color-border);"
          >
            #{tag}
          </a>
        ))}
      </div>
      <div class="flex gap-2 ml-auto">
        <button
          id="share-btn"
          class="p-2 rounded-lg transition-all hover:scale-110 hover:shadow-md"
          style="background-color: var(--color-bg-alt); border: 1px solid var(--color-border);"
          title="Share this post"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--color-text);">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="prose prose-lg max-w-none mb-12">
      <Content />
    </div>

    <AuthorCard author={author} />

    {relatedPosts.length > 0 && (
      <section class="mt-12 pt-8 border-t-2" style="border-color: var(--color-border);">
        <h2 class="text-2xl font-bold mb-6" style="color: var(--color-text);">Related Posts</h2>
        <div class="grid gap-4">
          {relatedPosts.map(related => (
            <article class="rounded-lg p-4 sm:p-6 hover:shadow-md transition-shadow" style="border: 1px solid var(--color-border);">
              <a href={`/blog/${related.id}`} class="no-underline group">
                <h3 class="text-lg sm:text-xl font-semibold mb-2 hover:opacity-80 transition-opacity" style="color: var(--color-primary);">
                  {related.data.title}
                </h3>
              </a>
              <p class="text-sm sm:text-base" style="color: var(--color-text-light);">
                {related.data.description}
              </p>
            </article>
          ))}
        </div>
      </section>
    )}
  </article>

  <!-- Sticky Table of Contents Sidebar -->
  {headings.length > 0 && (
    <aside class="hidden lg:block w-64 flex-shrink-0">
      <div class="sticky top-24 p-4 rounded-lg" style="background-color: var(--color-bg-alt); border: 1px solid var(--color-border);">
        <h3 class="font-bold mb-4 text-sm uppercase" style="color: var(--color-text);">Table of Contents</h3>
        <nav class="space-y-2">
          {headings.map(heading => (
            <a
              href={`#${heading.slug}`}
              class="block text-sm no-underline hover:underline transition-opacity hover:opacity-80"
              style={`color: var(--color-text-light); padding-left: ${(heading.depth - 1) * 0.75}rem;`}
            >
              {heading.text}
            </a>
          ))}
        </nav>
      </div>
    </aside>
  )}
  </div>

  <script>
    // Reading progress indicator
    function updateReadingProgress() {
      const article = document.querySelector('article');
      const progressBar = document.getElementById('reading-progress');

      if (!article || !progressBar) return;

      const articleTop = article.offsetTop;
      const articleHeight = article.offsetHeight;
      const windowHeight = window.innerHeight;
      const scrollTop = window.scrollY;

      const progress = Math.min(
        100,
        Math.max(0, ((scrollTop - articleTop + windowHeight) / articleHeight) * 100)
      );

      progressBar.style.width = `${progress}%`;
    }

    window.addEventListener('scroll', updateReadingProgress);
    window.addEventListener('resize', updateReadingProgress);
    updateReadingProgress();

    // Share functionality
    document.getElementById('share-btn')?.addEventListener('click', async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: document.title,
            url: window.location.href
          });
        } catch (err) {
          console.log('Share cancelled');
        }
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard!');
      }
    });

    // Add copy buttons to code blocks
    function addCopyButtonsToCodeBlocks() {
      const codeBlocks = document.querySelectorAll('.prose pre');

      codeBlocks.forEach((pre) => {
        // Skip if button already exists
        if (pre.querySelector('.code-copy-btn')) return;

        const button = document.createElement('button');
        button.className = 'code-copy-btn';
        button.textContent = 'Copy';
        button.setAttribute('aria-label', 'Copy code to clipboard');

        button.addEventListener('click', async () => {
          const code = pre.querySelector('code');
          if (!code) return;

          // Get text content without line numbers
          const lines = code.querySelectorAll('.line');
          let textToCopy = '';

          if (lines.length > 0) {
            // Extract text from each line (skipping line number pseudo-element)
            textToCopy = Array.from(lines)
              .map(line => line.textContent)
              .join('\n');
          } else {
            // Fallback to entire code text
            textToCopy = code.textContent || '';
          }

          try {
            await navigator.clipboard.writeText(textToCopy);
            button.textContent = 'Copied!';
            button.classList.add('copied');

            setTimeout(() => {
              button.textContent = 'Copy';
              button.classList.remove('copied');
            }, 2000);
          } catch (err) {
            console.error('Failed to copy code:', err);
            button.textContent = 'Error';
            setTimeout(() => {
              button.textContent = 'Copy';
            }, 2000);
          }
        });

        pre.appendChild(button);
      });
    }

    // Initialize copy buttons
    addCopyButtonsToCodeBlocks();
  </script>
</Layout>
