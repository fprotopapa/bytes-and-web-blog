---
import Layout from '../../layouts/Layout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';

// Get all published blog posts, sorted by date (newest first)
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

const sortedPosts = allPosts.sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Get unique categories and tags for the sidebar
const categories = [...new Set(allPosts.map(post => post.data.category))].sort();
const allTags = allPosts.flatMap(post => post.data.tags);
const uniqueTags = [...new Set(allTags)].sort();
---

<Layout title="All Posts - Embedded Linux Blog">
  <div class="grid grid-cols-1 md:grid-cols-[1fr_300px] gap-6 md:gap-8">
    <section>
      <h1 class="text-3xl font-bold mb-6" style="color: var(--color-text);">All Blog Posts</h1>
      <p class="mb-6" style="color: var(--color-text-light);">
        {sortedPosts.length} {sortedPosts.length === 1 ? 'post' : 'posts'} about embedded Linux, kernel development, and more.
      </p>

      <div class="space-y-6">
        {sortedPosts.map(post => (
          <PostCard post={post} />
        ))}
      </div>
    </section>

    <aside class="order-first md:order-last">
      <div class="md:sticky md:top-24 space-y-6">
        <div class="p-6 rounded-lg" style="background-color: var(--color-bg-alt);">
          <h3 class="text-xl font-semibold mb-4" style="color: var(--color-text);">Categories</h3>
          <ul class="space-y-2">
            {categories.map(category => {
              const count = allPosts.filter(p => p.data.category === category).length;
              return (
                <li>
                  <a
                    href={`/categories/${category.toLowerCase().replace(/\s+/g, '-')}`}
                    class="hover:underline hover:opacity-80 transition-opacity"
                    style="color: var(--color-primary);"
                  >
                    {category} ({count})
                  </a>
                </li>
              );
            })}
          </ul>
        </div>

        <div class="p-6 rounded-lg" style="background-color: var(--color-bg-alt);">
          <h3 class="text-xl font-semibold mb-4" style="color: var(--color-text);">Popular Tags</h3>
          <div class="flex flex-wrap gap-2">
            {uniqueTags.slice(0, 15).map(tag => (
              <a
                href={`/tags/${tag}`}
                class="px-3 py-1 rounded-full text-sm no-underline transition-colors hover:opacity-80"
                style="background-color: var(--color-bg); color: var(--color-text); border: 1px solid var(--color-border);"
              >
                #{tag}
              </a>
            ))}
          </div>
        </div>
      </div>
    </aside>
  </div>
</Layout>
