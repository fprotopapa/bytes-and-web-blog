---
import Layout from '../../../layouts/Layout.astro';
import AuthorCard from '../../../components/AuthorCard.astro';
import PostCard from '../../../components/PostCard.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import { getLangFromId } from '../../../content/config';
import { useTranslations } from '../../../i18n/utils';

const lang = 'en';
const t = useTranslations(lang);

export const getStaticPaths = (async () => {
  const authors = await getCollection('authors');
  // Only English authors
  const enAuthors = authors.filter(a => a.id.startsWith('en/'));
  return enAuthors.map(author => ({
    params: { slug: author.id.replace('en/', '') },
    props: { author },
  }));
}) satisfies GetStaticPaths;

const { author } = Astro.props;

// Get all posts by this author (English only)
const allPosts = await getCollection('blog', ({ id, data }) => {
  return data.draft !== true && data.author.id === author.id && getLangFromId(id) === lang;
});

const sortedPosts = allPosts.sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<Layout title={`${author.data.name} - ${t('author.profile')} - ${t('site.title')}`} lang={lang}>
  <h1 style="margin-bottom: 2rem;">{t('author.profile')}</h1>

  <AuthorCard author={author} />

  <section style="margin-top: 3rem;">
    <h2 style="margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--color-primary);">
      {t('author.postsBy')} {author.data.name} ({sortedPosts.length})
    </h2>

    {sortedPosts.length > 0 ? (
      sortedPosts.map(post => (
        <PostCard post={post} lang={lang} />
      ))
    ) : (
      <p style="color: var(--color-text-light); padding: 2rem; text-align: center; background-color: var(--color-bg-alt); border-radius: 0.5rem;">
        {t('author.noPosts')}
      </p>
    )}
  </section>
</Layout>
