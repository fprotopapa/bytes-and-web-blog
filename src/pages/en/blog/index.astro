---
import Layout from '../../../layouts/Layout.astro';
import PostCard from '../../../components/PostCard.astro';
import { getCollection } from 'astro:content';
import { getLangFromId } from '../../../content/config';
import { useTranslations, getPostCountText } from '../../../i18n/utils';

const lang = 'en';
const t = useTranslations(lang);

// Get all published blog posts for English, sorted by date (newest first)
const allPosts = await getCollection('blog', ({ id, data }) => {
  return data.draft !== true && getLangFromId(id) === lang;
});

const sortedPosts = allPosts.sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Get unique categories and tags for the sidebar
const categories = [...new Set(allPosts.map(post => post.data.category))].sort();
const allTags = allPosts.flatMap(post => post.data.tags);
const uniqueTags = [...new Set(allTags)].sort();
---

<Layout title={`${t('blog.allPosts')} - ${t('site.title')}`} lang={lang}>
  <div class="grid grid-cols-1 md:grid-cols-[1fr_300px] gap-6 md:gap-8">
    <section>
      <h1 class="text-3xl font-bold mb-6" style="color: var(--color-text);">{t('blog.allPosts')}</h1>
      <p class="mb-6" style="color: var(--color-text-light);">
        {getPostCountText(sortedPosts.length, lang)} {t('blog.description')}.
      </p>

      <div class="space-y-6">
        {sortedPosts.length > 0 ? (
          sortedPosts.map(post => (
            <PostCard post={post} lang={lang} />
          ))
        ) : (
          <p style="color: var(--color-text-light);">No posts available in English yet.</p>
        )}
      </div>
    </section>

    <aside class="order-first md:order-last">
      <div class="md:sticky md:top-24 space-y-6">
        <div class="p-6 rounded-lg" style="background-color: var(--color-bg-alt);">
          <h3 class="text-xl font-semibold mb-4" style="color: var(--color-text);">{t('blog.categories')}</h3>
          <ul class="space-y-2">
            {categories.map(category => {
              const count = allPosts.filter(p => p.data.category === category).length;
              return (
                <li>
                  <a
                    href={`/en/categories/${category.toLowerCase().replace(/\s+/g, '-')}`}
                    class="hover:underline hover:opacity-80 transition-opacity"
                    style="color: var(--color-primary);"
                  >
                    {category} ({count})
                  </a>
                </li>
              );
            })}
          </ul>
        </div>

        <div class="p-6 rounded-lg" style="background-color: var(--color-bg-alt);">
          <h3 class="text-xl font-semibold mb-4" style="color: var(--color-text);">{t('blog.popularTags')}</h3>
          <div class="flex flex-wrap gap-2">
            {uniqueTags.slice(0, 15).map(tag => (
              <a
                href={`/en/tags/${tag}`}
                class="px-3 py-1 rounded-full text-sm no-underline transition-colors hover:opacity-80"
                style="background-color: var(--color-bg); color: var(--color-text); border: 1px solid var(--color-border);"
              >
                #{tag}
              </a>
            ))}
          </div>
        </div>
      </div>
    </aside>
  </div>
</Layout>
