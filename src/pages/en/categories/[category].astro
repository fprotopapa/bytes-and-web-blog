---
import Layout from '../../../layouts/Layout.astro';
import PostCard from '../../../components/PostCard.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import { getLangFromId } from '../../../content/config';
import { useTranslations, getPostCountText } from '../../../i18n/utils';

const lang = 'en';
const t = useTranslations(lang);

export const getStaticPaths = (async () => {
  const allPosts = await getCollection('blog', ({ id, data }) => {
    return data.draft !== true && getLangFromId(id) === 'en';
  });

  const uniqueCategories = [...new Set(allPosts.map(post => post.data.category))];

  return uniqueCategories.map(category => {
    const filteredPosts = allPosts.filter(post => post.data.category === category);
    const slug = category.toLowerCase().replace(/\s+/g, '-');
    return {
      params: { category: slug },
      props: { posts: filteredPosts, category },
    };
  });
}) satisfies GetStaticPaths;

const { posts, category } = Astro.props;

const sortedPosts = posts.sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<Layout title={`${category} - ${t('site.title')}`} lang={lang}>
  <div style="margin-bottom: 2rem;">
    <a href="/en/categories" style="color: var(--color-text-light); text-decoration: none;">
      ‚Üê {t('categories.backToAll')}
    </a>
  </div>

  <h1 style="margin-bottom: 1rem;">
    <span style="color: var(--color-primary);">{category}</span>
  </h1>

  <p style="color: var(--color-text-light); margin-bottom: 2rem;">
    {getPostCountText(sortedPosts.length, lang)} {t('categories.inCategory')}
  </p>

  {sortedPosts.map(post => (
    <PostCard post={post} lang={lang} />
  ))}
</Layout>
