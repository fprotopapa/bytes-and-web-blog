---
import Layout from '../../../layouts/Layout.astro';
import PostCard from '../../../components/PostCard.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import { getLangFromId } from '../../../content/config';
import { useTranslations, getPostCountText } from '../../../i18n/utils';

const lang = 'en';
const t = useTranslations(lang);

export const getStaticPaths = (async () => {
  const allPosts = await getCollection('blog', ({ id, data }) => {
    return data.draft !== true && getLangFromId(id) === 'en';
  });

  const uniqueTags = [...new Set(allPosts.flatMap(post => post.data.tags))];

  return uniqueTags.map(tag => {
    const filteredPosts = allPosts.filter(post =>
      post.data.tags.includes(tag)
    );
    return {
      params: { tag },
      props: { posts: filteredPosts, tag },
    };
  });
}) satisfies GetStaticPaths;

const { posts, tag } = Astro.props;

const sortedPosts = posts.sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
---

<Layout title={`Tag: ${tag} - ${t('site.title')}`} lang={lang}>
  <div style="margin-bottom: 2rem;">
    <a href="/en/tags" style="color: var(--color-text-light); text-decoration: none;">
      ‚Üê {t('tags.backToAll')}
    </a>
  </div>

  <h1 style="margin-bottom: 1rem;">
    {t('tags.postsTaggedWith')}
    <span style="color: var(--color-primary);">#{tag}</span>
  </h1>

  <p style="color: var(--color-text-light); margin-bottom: 2rem;">
    {getPostCountText(sortedPosts.length, lang)} {t('tags.found')}
  </p>

  {sortedPosts.map(post => (
    <PostCard post={post} lang={lang} />
  ))}
</Layout>
